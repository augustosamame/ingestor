#!/usr/bin/env ruby

require 'ingestor'
require 'thor'
require 'active_support/inflector'

Ingestor::Config.ensure_working_directory!
module Ingestor
  class CommandLine < Thor

    desc "generate PATH", "Create a new ingestor for PATH. PATH should be an absolute path or URL"
    def generate(path)
      Ingestor::Config.ensure_output_directory!
      
      file_name   = File.basename(path).underscore.parameterize.underscore
      file_name   = %Q{#{Time.now.utc.strftime("%Y%m%d%H%M%S")}_#{file_name}.rb}
      
      generated_file = File.join( Ingestor::Config.output_directory, file_name )

      File.open(generated_file, 'w+') do |f|
        f.puts <<-HEREDOC
#! /usr/bin/env ruby
require 'ingestor'

######################################
#
# Order of block execution is:
#   * map_attributes
#   * before
#   * finder
#   * processor
#   * after
#
######################################

ingest "#{path}" do
  parser :plain_text
  # compressed true
  # includes_header false
  # parser_options delimiter: '|'
  
  # How to map out the columns from document to ActiveRecord
  map_attributes do |values|
    {
      # ... create your attributes hash here for ActiveRecord/ActiveModel/etc.
      # values may be a Hash (xml, json) or an Array (csv, plain_text)
    }
  end

  # before{ |attrs| attrs}

  # Your strategy for finding or instantiating a new object to be handled by the processor block
  finder do |attrs|
    MyClass.find( attrs[:id] ) || MyClass.new
  end
  
  # Enable/disable attribute protection in default processor
  # without_protection false  
  
  # The default processor simple calls update_attributes
  # processor do |attrs,record|  
  #  ... custom processor here ...
  # end
  
  # after { |record| record}
end
HEREDOC
      end

      say "Generated #{generated_file}"
    end
  end
end

Ingestor::CommandLine.start